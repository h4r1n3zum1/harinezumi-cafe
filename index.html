<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ハリネズミカフェ バーチャルオフィス</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      overflow: hidden;
      background: linear-gradient(135deg, #8B4513 0%, #D2691E 50%, #F4A460 100%);
      height: 100vh;
    }

    .main-container {
      display: flex;
      width: 100vw;
      height: 100vh;
    }

    .game-area {
      flex: 1;
      position: relative;
      background: linear-gradient(180deg, #F5DEB3 0%, #DEB887 30%, #8B4513 100%);
    }

    .chat-area {
      width: 400px;
      background: rgba(255, 255, 255, 0.95);
      border-left: 3px solid #8B4513;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .chat-header {
      background: #8B4513;
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 700;
      font-size: 18px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
    }

    .chat-input-area {
      padding: 15px;
      background: rgba(245, 222, 179, 0.9);
      border-top: 2px solid #8B4513;
    }

    .chat-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #8B4513;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
      font-family: inherit;
      margin-bottom: 10px;
    }

    .chat-input:focus {
      border-color: #D2691E;
      box-shadow: 0 0 10px rgba(139, 69, 19, 0.3);
    }
    .reaction-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .reaction-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #8B4513;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .reaction-btn:hover {
      transform: scale(1.1);
      background: rgba(139, 69, 19, 0.1);
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(139, 69, 19, 0.1);
      border-radius: 15px;
      border-left: 4px solid #8B4513;
    }

    .message-author {
      font-weight: 500;
      color: #8B4513;
      font-size: 12px;
      margin-bottom: 2px;
    }

    .message-text {
      color: #333;
      font-size: 14px;
    }

    .screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #8B4513;
      border-radius: 15px;
      padding: 40px;
      z-index: 3000;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      max-width: 500px;
      text-align: center;
    }

    .screen h2 {
      color: #8B4513;
      font-size: 28px;
      margin-bottom: 30px;
      font-weight: 700;
    }

    .name-input {
      width: 100%;
      padding: 15px;
      border: 2px solid #8B4513;
      border-radius: 10px;
      font-size: 18px;
      margin-bottom: 30px;
      font-family: inherit;
      text-align: center;
    }

    .name-input:focus {
      border-color: #D2691E;
      outline: none;
      box-shadow: 0 0 10px rgba(139, 69, 19, 0.3);
    }
  </style>
</head>
<body>

  <!-- 名前入力画面 -->
  <div class="screen" id="name-screen">
    <h2>🦔 ハリネズミカフェへようこそ</h2>
    <input type="text" id="name-input" class="name-input" placeholder="お名前を入力してください" maxlength="20">
    <button class="big-button" id="name-next-btn">次へ</button>
  </div>

  <!-- マグカップ選択画面 -->
  <div class="screen" id="mug-screen" style="display: none;">
    <h2>☕ マグカップを選んでください</h2>
    <div class="character-grid" id="character-grid"></div>
    <button class="big-button" id="start-btn" disabled>カフェに入る</button>
  </div>

  <!-- メインゲーム画面 -->
  <div class="main-container" id="main-container" style="display: none;">
    <div class="game-area" id="game-area"></div>

    <div class="chat-area">
      <div class="chat-header">💬 チャット</div>
      <div class="chat-messages" id="chat-messages"></div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" class="chat-input" placeholder="メッセージを入力..." maxlength="100">
        <div class="reaction-buttons">
          <button class="reaction-btn" data-reaction=\"❤️\">❤️</button>
          <button class="reaction-btn" data-reaction=\"⭐\">⭐</button>
          <button class="reaction-btn" data-reaction=\"😊\">😊</button>
          <button class="reaction-btn" data-reaction=\"👍\">👍</button>
        </div>
      </div>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script type="module">
    import { initializeApp } from \"https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js\";
    import { getDatabase, ref, set, onValue } from \"https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js\";

    const firebaseConfig = {
      // あなたのFirebase設定情報に置き換えてください
      apiKey: \"YOUR_API_KEY\",
      authDomain: \"YOUR_PROJECT.firebaseapp.com\",
      databaseURL: \"https://YOUR_PROJECT.firebaseio.com\",
      projectId: \"YOUR_PROJECT_ID\",
      storageBucket: \"YOUR_PROJECT.appspot.com\",
      messagingSenderId: \"YOUR_SENDER_ID\",
      appId: \"YOUR_APP_ID\"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const state = {
      userName: \"\",
      selectedMugColor: \"#8B4513\",
      playerId: \"id-\" + Math.random().toString(36).substr(2, 9),
      deviceId: navigator.userAgent,
      isFirebaseReady: true
    };

    let player;
    let cursors;
    let game;

    document.getElementById(\"name-next-btn\").addEventListener(\"click\", () => {
      const name = document.getElementById(\"name-input\").value.trim();
      if (!name) return;
      state.userName = name;
      document.getElementById(\"name-screen\").style.display = \"none\";
      document.getElementById(\"mug-screen\").style.display = \"block\";
      loadMugs();
    });

    function loadMugs() {
      const grid = document.getElementById(\"character-grid\");
      const colors = [\"#D2691E\", \"#8B4513\", \"#F4A460\", \"#CD853F\"];
      colors.forEach(color => {
        const div = document.createElement(\"div\");
        div.className = \"character-option\";
        div.innerHTML = `<div style=\"width:50px;height:50px;background:${color};border-radius:50% 50% 50% 50% / 60% 60% 40% 40%;border:3px solid #8B4513;\"></div>`;
        div.onclick = () => {
          state.selectedMugColor = color;
          document.querySelectorAll(\".character-option\").forEach(el => el.classList.remove(\"selected\"));
          div.classList.add(\"selected\");
          document.getElementById(\"start-btn\").disabled = false;
        };
        grid.appendChild(div);
      });
    }

    document.getElementById(\"start-btn\").addEventListener(\"click\", () => {
      document.getElementById(\"mug-screen\").style.display = \"none\";
      document.getElementById(\"main-container\").style.display = \"flex\";
      initializeGame();
    });

    function initializeGame() {
      const gameArea = document.getElementById(\"game-area\");
      game = new Phaser.Game({
        type: Phaser.AUTO,
        width: gameArea.clientWidth,
        height: gameArea.clientHeight,
        backgroundColor: \"#F5DEB3\",
        parent: \"game-area\",
        scene: { preload, create, update }
      });
    }
    function preload() {
      const g = this.add.graphics();
      const color = parseInt(state.selectedMugColor.replace(\"#\", \"0x\"), 16);
      g.fillStyle(color, 1);
      g.fillRoundedRect(0, 0, 40, 50, 20);
      g.generateTexture(\"player-mug\", 40, 50);
      g.destroy();
    }

    function create() {
      player = this.add.sprite(this.sys.game.config.width / 2, this.sys.game.config.height / 2, \"player-mug\").setDepth(10);
      cursors = this.input.keyboard.createCursorKeys();
    }

    function update() {
      const speed = 3;
      let moved = false;
      const gameWidth = this.cameras.main.width;
      const gameHeight = this.cameras.main.height;

      const margin = 50;
      const minX = margin;
      const maxX = gameWidth - margin;
      const minY = margin;
      const maxY = gameHeight - margin;

      if (cursors.left.isDown) {
        player.x -= speed;
        moved = true;
      }
      if (cursors.right.isDown) {
        player.x += speed;
        moved = true;
      }
      if (cursors.up.isDown) {
        player.y -= speed;
        moved = true;
      }
      if (cursors.down.isDown) {
        player.y += speed;
        moved = true;
      }

      // ✅ 画面外に出ないよう制限
      player.x = Phaser.Math.Clamp(player.x, minX, maxX);
      player.y = Phaser.Math.Clamp(player.y, minY, maxY);

      if (moved && state.isFirebaseReady) {
        const playerRef = ref(database, `players/${state.playerId}`);
        set(playerRef, {
          x: player.x,
          y: player.y,
          mugColor: state.selectedMugColor,
          deviceId: state.deviceId,
          userName: state.userName,
          timestamp: Date.now(),
          lastUpdate: Date.now()
        });
      }
    }

    // チャット送信処理
    const chatInput = document.getElementById(\"chat-input\");
    const chatMessages = document.getElementById(\"chat-messages\");
    chatInput.addEventListener(\"keypress\", e => {
      if (e.key === \"Enter\") {
        const text = chatInput.value.trim();
        if (text === \"\") return;
        const div = document.createElement(\"div\");
        div.className = \"message\";
        div.innerHTML = `<div class=\"message-author\">🦔 ${state.userName}</div><div class=\"message-text\">${text}</div>`;
        chatMessages.appendChild(div);
        chatInput.value = \"\";
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    });

    // リアクション処理（ローカル表示）
    document.querySelectorAll(\".reaction-btn\").forEach(btn => {
      btn.addEventListener(\"click\", () => {
        const emoji = btn.dataset.reaction;
        const el = document.createElement(\"div\");
        el.textContent = emoji;
        el.style.position = \"absolute\";
        el.style.left = `${player.x}px`;
        el.style.top = `${player.y - 60}px`;
        el.style.fontSize = \"24px\";
        el.style.zIndex = \"1000\";
        document.getElementById(\"game-area\").appendChild(el);
        setTimeout(() => el.remove(), 3000);
      });
    });
  </script>
</body>
</html>
