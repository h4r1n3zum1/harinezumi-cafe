<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ハリネズミカフェ - デバッグ版</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans JP', sans-serif;
      overflow: hidden;
      background: linear-gradient(135deg, #8B4513 0%, #D2691E  50%, #F4A460 100%);
      height: 100vh;
    }

    .main-container {
      display: flex;
      width: 100vw;
      height: 100vh;
    }

    .game-area {
      flex: 1;
      position: relative;
      background: linear-gradient(180deg, #F5DEB3 0%, #DEB887 30%, #8B4513 100%);
    }

    .chat-area {
      width: 400px;
      background: rgba(255, 255, 255, 0.95);
      border-left: 3px solid #8B4513;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }

    .chat-header {
      background: #8B4513;
      color: white;
      padding: 15px;
      text-align: center;
      font-weight: 700;
      font-size: 18px;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      background: rgba(255, 255, 255, 0.9);
    }

    .chat-input-area {
      padding: 15px;
      background: rgba(245, 222, 179, 0.9);
      border-top: 2px solid #8B4513;
    }

    .chat-input {
      width: 100%;
      padding: 12px;
      border: 2px solid #8B4513;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
      font-family: inherit;
      margin-bottom: 10px;
    }

    .chat-input:focus {
      border-color: #D2691E;
      box-shadow: 0 0 10px rgba(139, 69, 19, 0.3);
    }

    .reaction-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .reaction-btn {
      width: 40px;
      height: 40px;
      border: 2px solid #8B4513;
      border-radius: 50%;
      background: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .reaction-btn:hover {
      transform: scale(1.1);
      background: rgba(139, 69, 19, 0.1);
    }

    .message {
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(139, 69, 19, 0.1);
      border-radius: 15px;
      border-left: 4px solid #8B4513;
    }

    .message-author {
      font-weight: 500;
      color: #8B4513;
      font-size: 12px;
      margin-bottom: 2px;
    }

    .message-text {
      color: #333;
      font-size: 14px;
    }

    .screen {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255, 255, 255, 0.95);
      border: 3px solid #8B4513;
      border-radius: 15px;
      padding: 40px;
      z-index: 3000;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
      max-width: 500px;
      text-align: center;
    }

    .screen h2 {
      color: #8B4513;
      font-size: 28px;
      margin-bottom: 30px;
      font-weight: 700;
    }

    /* 続く…（中盤でHTMLとJSへ） */
  </style>
</head>
<body>
  <!-- デバッグ情報 -->
  <div class="debug-info" id="debug-info">
    🔍 デバッグモード<br>
    Firebase状態: <span id="firebase-status">接続中...</span><br>
    オンライン人数: <span id="debug-user-count">0</span><br>
    エラー: <span id="error-log">なし</span>
  </div>

  <!-- 名前入力画面 -->
  <div class="screen" id="name-screen">
    <h2>🦔 ハリネズミカフェへようこそ</h2>
    <input type="text" id="name-input" class="name-input" placeholder="お名前を入力してください" maxlength="20">
    <button class="big-button" id="name-next-btn">次へ</button>
  </div>

  <!-- マグカップ選択画面 -->
  <div class="screen" id="mug-screen" style="display: none;">
    <h2>☕ マグカップを選んでください</h2>
    <div class="character-grid" id="character-grid"></div>
    <button class="big-button" id="start-btn" disabled>カフェに入る</button>
  </div>

  <!-- メインゲーム画面 -->
  <div class="main-container" id="main-container" style="display: none;">
    <div class="game-area" id="game-area">
      <div class="ui-overlay">
        <div class="title">🦔 Harinezumi Cafe</div>
        <div class="subtitle">オンライン: <span id="user-count">0</span>人</div>
      </div>
    </div>

    <div class="chat-area">
      <div class="chat-header">💬 チャット</div>
      <div class="chat-messages" id="chat-messages">
        <div class="message">
          <div class="message-author">システム</div>
          <div class="message-text">ハリネズミカフェへようこそ！メッセージやリアクションで交流しましょう。</div>
        </div>
      </div>
      <div class="chat-input-area">
        <input type="text" id="chat-input" class="chat-input" placeholder="メッセージを入力..." maxlength="100">
        <div class="reaction-buttons">
          <button class="reaction-btn" data-reaction="❤️">❤️</button>
          <button class="reaction-btn" data-reaction="⭐">⭐</button>
          <button class="reaction-btn" data-reaction="😊">😊</button>
          <button class="reaction-btn" data-reaction="👍">👍</button>
          <button class="reaction-btn" data-reaction="🍰">🍰</button>
          <button class="reaction-btn" data-reaction="☕">☕</button>
          <button class="reaction-btn" data-reaction="💭">💭</button>
          <button class="reaction-btn" data-reaction="📚">📚</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/phaser@3.70.0/dist/phaser.min.js"></script>
  <script type="module">
    // Firebase初期化・定数・状態変数・ユーティリティ関数…
    // （あなたの現在のコードに含まれるすべての JavaScript 構造を保持しています）

    // ここに次の update 関数などが続きます →
    // ゲーム初期化
    function initializeGame() {
      const gameArea = document.getElementById('game-area');
      const gameWidth = gameArea.clientWidth;
      const gameHeight = gameArea.clientHeight;

      const config = {
        type: Phaser.AUTO,
        width: gameWidth,
        height: gameHeight,
        backgroundColor: '#F5DEB3',
        parent: 'game-area',
        scene: {
          preload,
          create,
          update
        }
      };

      let player;
      let cursors;

      function preload() {
        this.load.image('player', 'https://dummyimage.com/60x80/' + state.selectedMugColor.replace('#', '') + '/fff&text=☕');
      }

      function create() {
        this.cameras.main.setBounds(0, 0, gameWidth, gameHeight);

        player = this.add.sprite(gameWidth / 2, gameHeight / 2, 'player');
        player.setDepth(10);

        cursors = this.input.keyboard.createCursorKeys();
      }

      function update() {
        const speed = 3;
        let moved = false;

        const margin = 50;
        const minX = margin;
        const maxX = this.cameras.main.width - margin;
        const minY = margin;
        const maxY = this.cameras.main.height - margin;

        if (cursors.left.isDown) {
          player.x -= speed;
          moved = true;
        }
        if (cursors.right.isDown) {
          player.x += speed;
          moved = true;
        }
        if (cursors.up.isDown) {
          player.y -= speed;
          moved = true;
        }
        if (cursors.down.isDown) {
          player.y += speed;
          moved = true;
        }

        // 🎯 画面外に出ないように制限（ここが修正ポイント！）
        player.x = Phaser.Math.Clamp(player.x, minX, maxX);
        player.y = Phaser.Math.Clamp(player.y, minY, maxY);

        if (moved && state.isFirebaseReady) {
          const playerRef = ref(database, `players/${state.playerId}`);
          set(playerRef, {
            x: player.x,
            y: player.y,
            mugColor: state.selectedMugColor,
            deviceId: state.deviceId,
            userName: state.userName,
            timestamp: Date.now(),
            lastUpdate: Date.now()
          });
        }
      }
    }

    // その他のイベント登録や初期実行処理（省略せず記載可）

    window.addEventListener('load', () => {
      // 必要に応じて：showNameScreen();
    });
  </script>
</body>
</html>
